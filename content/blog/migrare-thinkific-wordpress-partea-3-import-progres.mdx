---
title: 'Cum migrezi de la Thinkific la WordPress. Partea 3: Import progres'
locale: ro
featuredImage: https://res.cloudinary.com/vladilie-ro/image/upload/v1706196659/blog/1.%20migrate-thinkific-to-wordpress/v5ypjuldovovlpqw1cc3.webp
blurDataImage: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAxUlEQVR4nAG6AEX/ANLS0t/f3+vr6+3t6+/y8fHy7/X39+/y8ens693f3gCZr8qmutOqwtuyxNrK1+b7+/j8//75/Pv19/fo6u0AOG2gKGGRNGiYPHCgUoO2gLPNnNXgmtLels/ZkMrVAKO51qnA3J2zy52yzH+0yxSesQB4iABOWwBicgCKoQDHx8VaTTwkEgAnEwBRQSxNTjkEGREADQA/Vkxmk5oAHg8ARzATLxsAHQAAHgIAMyAGOiQNUTsgaU8yPSsXAbliTzFAqmUAAAAASUVORK5CYII=
description: Cum am folosit WP-CLI pentru a rula importul de progres dintr-un fiÈ™ier CSV exportat din Thinkific.
type: Post
keywords: [migrare,thinkific,wordpress,tutor lms,woocommerce,wp-cli,funcÈ›ii,comenzi,import progres,citire din fiÈ™ier,capitol,lecÈ›ie]
date: January 30, 2024 08:00:00
---
Ãn <Link href="/blog/migrare-thinkific-wordpress-partea-2-planificare-pregatire-date">partea a doua</Link> a acestei serii de 5 articole am vorbit despre cum am fÄƒcut implementarea pentru comanda personalizatÄƒ `WP-CLI` de importare a utilizatorilor.

Ãn **partea a treia** voi descrie funcÈ›ionalitatea comenzii `WP-CLI` pentru a importa progresul utilizatorilor Ã®n privinÈ›a cursurilor la care sunt Ã®nrolaÈ›i Ã®n platforma `Thinkific`.
Mai jos Ã®È›i las È™i lista de articole din serie:
<div className='rounded-md border p-2 bg-gray-50 dark:bg-slate-900'>
    <p>Cuprins</p>
    1. <Link href="/blog/migrare-thinkific-wordpress-partea-1-planificare-pregatire-date">Partea 1: Planificarea È™i pregÄƒtirea datelor</Link>
    2. <Link href="/blog/migrare-thinkific-wordpress-partea-2-import-utilizatori">Partea 2: Import utilizatori</Link>
    3. _**Partea 3: Import progres**_
    4. <Link href="/blog/migrare-thinkific-wordpress-partea-4-import-recenzii">Partea 4: Import recenzii</Link>
    5. <Link href="/blog/migrare-thinkific-wordpress-partea-5-adaptari-concluzii">Partea 5: Alte adaptÄƒri È™i concluzii</Link>
</div>

## Definirea metodei de import progres
Am cÃ¢te un fiÈ™ier de progres `CSV` pentru fiecare curs existent, din care voi citi pe rÃ¢nd folosind o instrucÈ›iune recursivÄƒ.

Pentru Ã®nceput definesc metoda de import progres, declar variabilele globale, includ È™i apelez funcÈ›ia `WP_Filesystem` din `WordPress`.
```php showLineNumbers title="class-wpcli.php"
public function import_progress() {
    global $wp_filesystem, $wpdb;

    include_once ABSPATH . 'wp-admin/includes/file.php';
    WP_Filesystem();
    // ...
}
```
Definesc apoi un vector atributiv cu lista cu fiÈ™iere de progres din care se va face citirea È™i ID-ul cursului pentru care este progresul respectiv:
```php showLineNumbers title="class-wpcli.php"
$files         = array(
    'course-1-progress.csv' => 10, // Course name 1
    'course-2-progress.csv' => 11, // Course name 2
    'course-3-progress.csv' => 12, // Course name 3
    'course-4-progress.csv' => 13, // Course name 4
);

$file_basepath = plugin_dir_path( __FILE__ ) . 'data/progress/';
```
È˜i prin instrucÈ›iunea `foreach ( $files as $file => $course_id )` parcurg lista de fiÈ™iere È™i Ã®ncep citirea din ele:
```php showLineNumbers title="class-wpcli.php"
$file_content = $wp_filesystem->get_contents( $file_basepath . $file );
$csv_data     = $this->parse_csv_content( $file_content );
$i            = 0;
$lesson_names = array();
$time         = time();
```
Am refolosit metoda `parse_csv_content` pentru a transforma liniile din `CSV` Ã®ntr-un vector, metodÄƒ pe care am definit-o Ã®n <Link href="/blog/migrare-thinkific-wordpress-partea-2-import-utilizatori">partea a doua</Link> la importul utilizatorilor.
Am definit È™i variabilele `$i`, `$lesson_names` È™i `$time` pe care le voi folosi mai jos.

## Parcurgerea È™i procesarea datelor
Ca sÄƒ nu Ã®ncurc prea mult iÈ›ele, am sÄƒ pun toatÄƒ partea cu parcurgerea È™i procesarea datelor È™i voi aduce comentarii dupÄƒ ea:
```php showLineNumbers title="class-wpcli.php"
foreach ( $csv_data as $line ) {
    if ( ! $i ) {
        $i++;
        $chapter_names = array_slice( $line, 3 );
        continue;
    }

    list($email, $completed_at, $percent_completed) = array_slice( $line, 0, 3 );

    $user = get_user_by( 'email', $email );
    if ( ! $user ) {
        \WP_CLI::error( sprintf( 'The user with email address %s does not exist.', $email ) );
    }

    $chapter_progress = array_slice( $line, 3 );
    $count            = count( $chapter_progress );
    for ( $j = 0; $j < $count; $j++ ) {
        if ( '100' === $chapter_progress[ $j ] ) {
            $lesson_id = $wpdb->get_var(
                $wpdb->prepare(
                    "SELECT ID
                    FROM $wpdb->posts
                    WHERE post_parent = (
                        SELECT ID
                        FROM $wpdb->posts
                        WHERE post_title = %s AND post_parent = %d
                    )",
                    $chapter_names[ $j ],
                    $course_id
                )
            );

            if ( ! $lesson_id ) {
                \WP_CLI::error( sprintf( 'The lesson named â€%sâ€ of the course â€â€ not found.', $chapter_names[ $j ], $course_id ) );
            }

            $updated = update_user_meta( $user->ID, '_tutor_completed_lesson_id_' . $lesson_id, $time );

            if ( ! $updated ) {
                \WP_CLI::warning( sprintf( 'Update status: â€%sâ€. That means failure or the value already exists.', $updated ) );
            }
        }
    }

    $i++;
}
```
Ãn liniile 2-6 am sÄƒrit din nou peste prima linie din fiÈ™ierul `CSV` care conÈ›ine numele coloanelor, dar Ã®n acelaÈ™i timp am pÄƒstrat È™i numele lecÈ›iilor (linia 4) Ã®n variabila `$lesson_names` pentru cÄƒ am nevoie de ele Ã®n interogarea de mai jos.
DacÄƒ Ã®È›i aminteÈ™ti din prima parte de la <Link href="/blog/migrare-thinkific-wordpress-partea-1-planificare-pregatire-date">pregÄƒtirea datelor</Link>, prima linie a fiÈ™ierului `CSV` de progres arÄƒta aÈ™a:
```csv
Email,Completed At,% Completed,<Nume-capitol-1>,<Nume-capitol-2>,...,<Nume-capitol-n>
```
Cu funcÈ›ia `array_slice` am trecut peste primele 3 cÃ¢mpurilor (`Email`, `Completed At` È™i `% Completed`) È™i mi-au fost returnate urmÄƒtoarele pÃ¢nÄƒ la final, Ã®n variabila `$lesson_names`.
Aici au fost stocate _numele capitolelor_ din curs.

Ãn aceeaÈ™i manierÄƒ, pe linia 15 am stocat _progresul lecÈ›iei_ respective.

Pe linia 8 am folosit aceeaÈ™i funcÈ›ie, de data asta pentru a stoca **primele** 3 valori.

Se face apoi o cÄƒutare dupÄƒ adresa de email a utilizatorului.
Ãn principiu nu ar trebui sÄƒ fie probleme la aceastÄƒ cÄƒutare pentru cÄƒ utilizatorii ar trebui sÄƒ fie creaÈ›i Ã®n pasul de la importul utilizatorilor.
Oricum, pentru orice eventualitate am pus acolo È™i o verificare cu mesaj de eroare.

Ãn final, Ã®ncepÃ¢nd cu linia 16 se Ã®ncepe parcurgerea progresurilor lecÈ›iilor.

## Procesare progres capitol - lecÈ›ie
Spuneam la un moment dat cÄƒ am fÄƒcut un compromis È™i am procesat doar capitolele al cÄƒror progres este `100`.

Ca sÄƒ fie totul clar: conÈ›inutul cursurilor poate fi organizat, atÃ¢t Ã®n `Thinkific` cÃ¢t È™i Ã®n `Tutor LMS`, Ã®n capitole cu lecÈ›ii, subiecte cu lecÈ›ii sau cum vrei sÄƒ-i spui.
Deci sunt doar douÄƒ niveluri de ierarhie.
Progresul se referÄƒ doar la capitole (sau subiecte), nu È™i la lecÈ›iile din ele, iar fiÈ™ierul `CSV` este generat de cÄƒtre `Thinkific` Ã®n consecinÈ›Äƒ.

Astfel cÄƒ, spre exemplu, un capitol cu 3 lecÈ›ii È™i un progres de 67 (%), presupune cÄƒ 2 dintre lecÈ›iile sale au fost finalizate.
Ãn mod real nu È™tiu care sunt cele 2 lecÈ›ii dintre cele 3 au fost finalizate, dar mi-am asumat cÄƒ primele 2, dacÄƒ iau Ã®n considerare ordinea naturalÄƒ de parcurgere a unui curs.

Acum, Ã®n `Tutor LMS` abordarea este urmÄƒtoarea: progresul trebuie setat per lecÈ›ie È™i doar Ã®n starea fie finalizatÄƒ, fie nefinalizatÄƒ.
CÃ¢mpul din baza de date pentru progresul unui curs al unui utilizator este stocat Ã®n tabelul `_usermeta` Ã®n modul urmÄƒtor:
```markdown
| umeta_id | user_id | meta_key                      | meta_value |
| -------- | ------- | ----------------------------- | ---------- |
| 12345    | 678     | _tutor_completed_lesson_id_90 | 1705610847 |
```
Utilizatorul cu ID `678` a finalizat lecÈ›ia cu ID `90` Ã®n data cu unixtimestamp `1705610847` (care corespunde datei joi, 18 ianuarie 2024, ora 22:47:27 GMT+0200).
LecÈ›ia cu ID `90` are la rÃ¢ndul ei un ID pÄƒrinte.
PÄƒrintele respectiv reprezintÄƒ capitolul lecÈ›iei respective.

Ãn proiectul Masterclass, un singur curs are un capitol cu 3 lecÈ›ii.
Restul capitolelor au cÃ¢te o lecÈ›ie.
Din punctul de vedere al migrÄƒrii progresului, avÃ¢nd doar 8 cazuri Ã®n care progresul acelui capitol nu a fost `100` (dacÄƒ È›in bine mine ğŸ¤”), treaba mea a fost uÈ™oarÄƒ.
Actualizarea manualÄƒ Ã®n baza de date a acelui progres a fost o operaÈ›ie de doar 2 minute.

## CÄƒutarea È™i actualizarea progresului lecÈ›iei
Variabila `$lesson_id` a reÈ›inut, Ã®n limbaj natural, â€ID-ul articolului al cÄƒrui cÃ¢mp **post_parent** este articolul cu ID al cÄƒrui **post_title** este numele capitolului È˜I **post_parent** este ID-ul cursului din iteraÈ›ia curentÄƒâ€.
È˜tiu, sunÄƒ destul de ciudat, dar cam aÈ™a se traduce interogarea ğŸ˜.

Ãn final se actualizeazÄƒ cÃ¢mpul `_tutor_completed_lesson_id_*` al utilizatorului, iar el va vedea Ã®n panoul `WordPress` progresul pe care l-a avut pe `Thinkific`.

## Ãncheiere
UrmeazÄƒ sÄƒ fie rulatÄƒ È™i comanda de import progres È™i din nou se Ã®ntÃ¢mplÄƒ magia. ğŸ§™ğŸ¼â€â™‚ï¸
```sh
$ wp thinkific import progress
```

ÃncÄƒ un pas È™i migrarea este finalizatÄƒ.
Ãn <Link href="/blog/migrare-thinkific-wordpress-partea-4-import-recenzii">urmÄƒtorul articol</Link> voi folosi API-ul de comentarii din `WordPress` pentru migrarea recenziilor, aÈ™a cÄƒ te invit sÄƒ-l studiezi ğŸ˜.

<div className='mb-4 flex flex-col items-center rounded-md border border-blue-600 p-2'>
    <p className="text-center mt-0">_DacÄƒ ai nevoie de o astfel de migrare, dÄƒ clic mai jos È™i hai sÄƒ discutÄƒm._</p>
    <Link href='/contact' className="animate-text-bg rounded-md bg-linear-to-r from-blue-600 via-gray-600 to-green-500 bg-[length:400%] px-2 py-1 text-white hover:text-white">ContacteazÄƒ-mÄƒ</Link>
</div>