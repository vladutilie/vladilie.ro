---
title: 'Cum migrezi de la Thinkific la WordPress. Partea 2: Import utilizatori'
locale: ro
featuredImage: https://res.cloudinary.com/vladilie-ro/image/upload/v1706196659/blog/1.%20migrate-thinkific-to-wordpress/v5ypjuldovovlpqw1cc3.webp
blurDataImage: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAxUlEQVR4nAG6AEX/ANLS0t/f3+vr6+3t6+/y8fHy7/X39+/y8ens693f3gCZr8qmutOqwtuyxNrK1+b7+/j8//75/Pv19/fo6u0AOG2gKGGRNGiYPHCgUoO2gLPNnNXgmtLels/ZkMrVAKO51qnA3J2zy52yzH+0yxSesQB4iABOWwBicgCKoQDHx8VaTTwkEgAnEwBRQSxNTjkEGREADQA/Vkxmk5oAHg8ARzATLxsAHQAAHgIAMyAGOiQNUTsgaU8yPSsXAbliTzFAqmUAAAAASUVORK5CYII=
description: Cum am folosit WP-CLI pentru a rula importul de utilizatori dintr-un fiÈ™ier CSV exportat din Thinkific.
type: Post
keywords: [migrare,thinkific,wordpress,tutor lms,woocommerce,wp-cli,funcÈ›ii,comenzi,import utilizatori,citire din fiÈ™ier]
date: January 29, 2024 20:00:00
---
Ãn <Link href="/blog/migrare-thinkific-wordpress-partea-1-planificare-pregatire-date">prima partea</Link> din aceastÄƒ serie de 5 articole am vorbit despre proiectul pentru care am fÄƒcut migrarea, cum am fÄƒcut planul de migrare È™i cum am exportat datele din `Thinkific`.

Aici, Ã®n **partea a doua** voi acoperi funcÈ›ionalitatea comenzii `WP-CLI` pe care am implementat-o pentru a importa utilizatorii Ã®n `WordPress`.
Mai jos Ã®È›i las È™i lista de articole din serie:
<div className='rounded-md border p-2 bg-gray-50 dark:bg-slate-900'>
    <p>Cuprins</p>
    1. <Link href="/blog/migrare-thinkific-wordpress-partea-1-planificare-pregatire-date">Partea 1: Planificarea È™i pregÄƒtirea datelor</Link>
    2. _**Partea 2: Import utilizatori**_
    3. <Link href="/blog/migrare-thinkific-wordpress-partea-3-import-progres">Partea 3: Import progres</Link>
    4. <Link href="/blog/migrare-thinkific-wordpress-partea-4-import-recenzii">Partea 4: Import recenzii</Link>
    5. <Link href="/blog/migrare-thinkific-wordpress-partea-5-adaptari-concluzii">Partea 5: Alte adaptÄƒri È™i concluzii</Link>
</div>

DupÄƒ cum spuneam, aici Ã®ncepe partea cea mai interesantÄƒ din tot procesul de migrare a datelor din `Thinkific` Ã®n `WordPress`.
IntenÈ›ia mea este de a crea un modul care sÄƒ Ã®nglobeze tot ceea ce am avut nevoie pentru comenzile personalizate de `WP-CLI`, Ã®n speÈ›Äƒ clasa `PHP` pe care am implementat-o.

Voi parcurge pe rÃ¢nd punctele cheie din clasÄƒ È™i voi explica pe parcurs abordÄƒrile.

## Declararea comenzilor personalizate `WP-CLI`
Pentru Ã®nceput am definit o metodÄƒ Ã®n care am adÄƒugat 3 comenzi personalizate `WP-CLI` pe care le-am implementat mai departe:
```php showLineNumbers title="class-wpcli.php"
// ...
protected function define_commands(): void {
    if ( class_exists( 'WP_CLI' ) ) {
        \WP_CLI::add_command( 'thinkific import users', array( $this, 'import_users' ) );
        \WP_CLI::add_command( 'thinkific import progress', array( $this, 'import_progress' ) );
        \WP_CLI::add_command( 'thinkific import reviews', array( $this, 'import_reviews' ) );
    }
}
// ...
```
UrmeazÄƒ ca aceste 3 comenzi sÄƒ fie disponibile Ã®n rularea lor Ã®ntr-un terminal shell utilizÃ¢nd `WP-CLI`.

## Citirea din fiÈ™ier
Ãn toate cele 3 callback-uri derivate din metoda de mai sus È™i anume `import_users`, `import_progress` È™i `import_reviews` a fost nevoie de citire din fiÈ™ierele cu date (2 fiÈ™iere `CSV` È™i un fiÈ™ier `JSON`).
Pentru asta am folosit API-ul din clasa `WP_Filesystem` care aparÈ›ine de `WordPress` È™i care m-a ajutat sÄƒ pÄƒstrez codul destul de curat È™i Ã®n limitele standardelor.
```php showLineNumbers title="class-wpcli.php"
public function import_users(): void {
    global $wp_filesystem;

    include_once ABSPATH . 'wp-admin/includes/file.php';
    WP_Filesystem();

    $file_path    = plugin_dir_path( __FILE__ ) . 'data/users.csv';
    $file_content = $wp_filesystem->get_contents( $file_path );
    $csv_data     = $this->parse_csv_content( $file_content );
    //...
}
```

DupÄƒ cum se observÄƒ, am implementat o altÄƒ metodÄƒ de ajutor pentru a interpreta conÈ›inutul `CSV` Ã®ntr-un format uÈ™or de parcurs È™i anume vector:
```php showLineNumbers title="class-wpcli.php"
protected function parse_csv_content( $csv_content ): array {
    $lines = explode( "\n", $csv_content );
    $data  = array();

    foreach ( $lines as $line ) {
        $data[] = str_getcsv( $line );
    }

    return $data;
}
```

Apoi am putut sÄƒ parcurg simplu liniile din fiÈ™ierul `CSV` È™i sÄƒ purced mai departe la procesarea datelor:
```php showLineNumbers title="class-wpcli.php"
foreach ( $csv_data as $line ) {
    if ( ! $i ) {
        $i++;
        continue;
    }

    list(, , , , , , $courses) = $line;
    $course_arr                = explode( ', ', $courses );
    if ( count( $course_arr ) && ! empty( $course_arr[0] ) ) {
        $user_id = $this->create_user( $line );
        $this->create_woo_order( $line, $user_id );
    }

    $i++;
}
```
Evident am sÄƒrit peste capul de tabel (Ã®n liniile 2-5).
Apoi am procesat doar utilizatorii care sunt Ã®nrolaÈ›i la cel puÈ›in un curs (linia 9).
Au fost cÃ¢teva cazuri Ã®n care utilizatorii erau doar Ã®nscriÈ™i pe platformÄƒ, dar nu aveau niciun curs achiziÈ›ionat.
Ãn consecinÈ›Äƒ nu avea rost sÄƒ migrez È™i aceste date, nefiind relevante.

Apoi, pentru ceilalÈ›i utilizatori, am apelat cele douÄƒ metode: de creare utilizator È™i de creeare comandÄƒ Ã®n `WooCommerce` - spuneam mai sus cÄƒ este nevoie de a mÄƒ integra cu procesul normal de achiziÈ›ie curs prin `Tutor LMS - WooCommerce`.

## Creare utilizator
Ãn metoda de creare utilizator nu am fÄƒcut ceva Ã®n mod special.
Am transmis cÄƒtre metodÄƒ informaÈ›iile din linia `CSV` È™i Ã®n cazul Ã®n care utilizatorul cÄƒutat dupÄƒ adresa de email nu existÄƒ deja, Ã®l creez.
Ãn ambele este returnat ID-ul utilizatorului È™i doar Ã®n caz de eroare de creare utilizator este returnat `null`.

```php showLineNumbers title="class-wpcli.php"
protected function create_user( $user_data ) {
    list($first_name, $last_name, , $created_at, $email) = $user_data;
    $user = get_user_by( 'email', $email );

    // User already exists, return current user ID.
    if ( $user ) {
        $user_id = $user->get( 'ID' );

        return $user->get( 'id' );
    }

    $user_id = wp_insert_user(
        array(
            'user_login'      => $email,
            'user_email'      => $email,
            'first_name'      => $first_name,
            'last_name'       => $last_name,
            'use_ssl'         => true,
            'user_registered' => str_replace( ' UTC', '', $created_at ),
        )
    );
    if ( is_wp_error( $user_id ) ) {
        \WP_CLI::error( sprintf( 'Error creating user %1$s %2$s <%3$s>: %4$s', $first_name, $last_name, $email, $user_id->get_error_message() ) );

        return null;
    } else {
        // User created.
        return $user_id;
    }
}
```
BineÃ®nÈ›eles, la crearea utilizatorului am folosit datele din fiÈ™ier È™i am fÄƒcut o interpretare a datei de Ã®nregistrare pentru cÄƒ formatul furnizat nu este acelaÈ™i cu cel acceptat de structura din tabelul de utilizatori `WordPress` - am eliminat partea cu `UTC` din datÄƒ.

## Creare comandÄƒ `WooCommerce`
Sper cÄƒ m-am fÄƒcut Ã®nÈ›eles prin â€creare comandÄƒ `WooCommerceâ€`.
Ca sÄƒ fie clar, mÄƒ refer la o comandÄƒ de produse Ã®ntr-un magazin online creat cu `WooCommerce` care urmeazÄƒ sÄƒ fie plÄƒtitÄƒ È™i aÈ™a mai departe.
Ãn metoda de creare comandÄƒ `WooCommerce` am fÄƒcut o potrivire manualÄƒ cu ID-urile produselor pentru cursuri, dupÄƒ cum se vede mai jos Ã®n liniile 2-8.

ID-urile 1, 2, 3 È™i 4 sunt ale produselor din baza de date care sunt atribuite cursurilor respective din modulul `Tutor LMS`.
Evident, ID-urile reale sunt altele.
```php showLineNumbers title="class-wpcli.php"
protected function create_woo_order( array $data, int $user_id ): void {
    $raw_course_list = array(
        // course_title => product_id.
        'Course title 1' => 1,
        'Course title 2' => 2,
        'Course title 3' => 3,
        'Course title 4' => 4,
    );

    list($first_name, $last_name, , $created_at, $email, , $courses) = $data;

    $order = wc_create_order(
        array(
            'customer_id' => $user_id,
            'status'      => 'wc-completed',
        )
    );

    $course_list = explode( ', ', $courses );
    // Add products to order.
    foreach ( $course_list as $course_name ) {
        $course_id = $raw_course_list[ $course_name ];
        $order->add_product( wc_get_product( $course_id ), 1 ); // 1 is for quantity.
    }

    $order->calculate_totals();

    $address = array(
        'first_name' => $first_name,
        'last_name'  => $last_name,
        'email'      => $email,
        'country'    => 'RO',
    );
    $order->set_address( $address, 'billing' );
    $order->set_payment_method( 'cod' );
    $order->set_date_created( $created_at );
    $order->set_date_completed( $created_at );
    $order->set_date_paid( $created_at );

    $order->save();
}
```
Ãn loc de variabila `$raw_course_list` aÈ™ fi putut sÄƒ fac o cÄƒutare Ã®n baza de date dupÄƒ cursuri È™i atribuirea ID-urilor sÄƒ fie dinamicÄƒ, dar aÈ™ fi introdus Ã®ncÄƒ o cerere cÄƒtre baza de date È™i aÈ™ fi complicat lucrurile.
DacÄƒ ar fi fost vorba de mult mai multe cursuri, probabil cÄƒ aÈ™a aÈ™ fi fÄƒcut pentru a-mi salva timp.

Am Ã®nceput mai departe sÄƒ pregÄƒtesc â€comandaâ€, am pus cursurile Ã®n coÈ™, am calculat totalurile, am setat adresa clientului, metoda de platÄƒ È™i data È™i am setat â€comandaâ€ ca plÄƒtitÄƒ.
Din acel moment utilizatorul se transformÄƒ Ã®n cursant pe noua platformÄƒ de e-learning.

## Ãncheiere
Cam asta a fost tot cu importul utilizatorilor, rÄƒmÃ¢ne sÄƒ rulez comanda È™i magia se Ã®ntÃ¢mplÄƒ. ğŸª„
```sh
$ wp thinkific import users
```

<Link href="/blog/migrare-thinkific-wordpress-partea-3-import-progres">UrmÄƒtorul articol</Link> va decurge cam Ã®n aceeaÈ™i manierÄƒ, dar sunt È™i acolo cÃ¢teva lucruri interesante de notat.

<div className='mb-4 flex flex-col items-center rounded-md border border-blue-600 p-2'>
    <p className="text-center mt-0">_DacÄƒ ai nevoie de o astfel de migrare, dÄƒ clic mai jos È™i hai sÄƒ discutÄƒm._</p>
    <Link href='/contact' className="animate-text-bg rounded-md bg-gradient-to-r from-blue-600 via-gray-600 to-green-500 bg-[length:400%] px-2 py-1 text-white hover:text-white">ContacteazÄƒ-mÄƒ</Link>
</div>